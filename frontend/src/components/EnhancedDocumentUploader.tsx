import { useState, useRef } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Upload, Camera, FileText, Check, Edit, Save, X, AlertTriangle, Files, Trash2, Shield, Copy, DollarSign, Zap, Mic, Eye } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { openaiVisionService, type ProcessedData, type BatchProcessingResult } from \"@/services/openaiVision\";\nimport { duplicateDetectionService, type DuplicateCheckResult } from \"@/services/duplicateDetection\";\nimport { multiModalAPI } from \"@/services/multiModalAPI\";\nimport { supabase } from \"@/integrations/supabase/client\";\nimport MultiModalUploader from \"./MultiModalUploader\";\n\ninterface ExtractedData extends ProcessedData {\n  id: string;\n  needsReview?: boolean;\n  sourceFile?: string;\n  isDuplicate?: boolean;\n  duplicateInfo?: DuplicateCheckResult;\n}\n\n// Dynamic confidence threshold based on amount
const getConfidenceThreshold = (amount: number): number => {
  if (amount > 50000) return 0.85; // High-value transactions need 85%+ confidence
  if (amount > 10000) return 0.75; // Medium-value transactions need 75%+ confidence
  return 0.65; // Low-value transactions need 65%+ confidence
};

// Validate earnings data before saving
const validateEarningsData = (item: ExtractedData) => {
  const errors = [];
  
  // Date validation
  const date = new Date(item.date);
  if (isNaN(date.getTime())) errors.push("Invalid date");
  if (date > new Date()) errors.push("Date is in future");
  if (date < new Date(new Date().setFullYear(new Date().getFullYear() - 2))) 
    errors.push("Date too old (>2 years)");
  
  // Amount validation
  if (item.amount <= 0) errors.push("Amount must be positive");
  if (item.amount > 1000000) errors.push("Amount suspiciously high (>‚Çπ10L)");
  
  return { isValid: errors.length === 0, errors };
};

export function DocumentUploader() {\n  const [activeTab, setActiveTab] = useState(\"multimodal\");\n  const [uploadedFiles, setUploadedFiles] = useState<File[]>([]);\n  const [extractedData, setExtractedData] = useState<ExtractedData[]>([]);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [isBatchMode, setIsBatchMode] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [previewUrl, setPreviewUrl] = useState<string>(\"\");\n  const [processingError, setProcessingError] = useState<string | null>(null);\n  const [batchProgress, setBatchProgress] = useState({ completed: 0, total: 0, currentFile: '' });\n  const [batchResults, setBatchResults] = useState<BatchProcessingResult | null>(null);\n  const [duplicateChecks, setDuplicateChecks] = useState<Map<string, DuplicateCheckResult>>(new Map());\n  const [duplicatesBlocked, setDuplicatesBlocked] = useState(0);\n  const [isSaving, setIsSaving] = useState(false);\n  const [saveSuccess, setSaveSuccess] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const handleFileUpload = async (files: FileList | File[]) => {\n    const fileArray = Array.from(files);\n    const validFiles = fileArray.filter(file => \n      file.type.startsWith('image/') || file.type === 'application/pdf'\n    );\n    \n    if (validFiles.length === 0) {\n      setProcessingError('Please select valid image or PDF files.');\n      return;\n    }\n\n    // Check for duplicates before processing\n    const duplicateResults = new Map<string, DuplicateCheckResult>();\n    let duplicateCount = 0;\n    \n    for (const file of validFiles) {\n      const duplicateCheck = await duplicateDetectionService.checkForDuplicate(file);\n      duplicateResults.set(file.name, duplicateCheck);\n      if (duplicateCheck.isDuplicate) {\n        duplicateCount++;\n      }\n    }\n    \n    setDuplicateChecks(duplicateResults);\n    \n    if (duplicateCount > 0) {\n      setDuplicatesBlocked(duplicateCount);\n      setProcessingError(\n        `${duplicateCount} duplicate file${duplicateCount > 1 ? 's' : ''} detected. ` +\n        `These ${duplicateCount > 1 ? 'have' : 'has'} already been processed.`\n      );\n    }\n    \n    // Filter out exact duplicates\n    const nonDuplicateFiles = validFiles.filter(file => {\n      const check = duplicateResults.get(file.name);\n      return !check?.isDuplicate || check.matchType !== 'exact';\n    });\n    \n    if (nonDuplicateFiles.length === 0) {\n      setProcessingError('All selected files are duplicates and have already been processed.');\n      return;\n    }\n    \n    setUploadedFiles(nonDuplicateFiles);\n    setIsProcessing(true);\n    if (duplicateCount === 0) {\n      setProcessingError(null);\n    }\n    setExtractedData([]);\n    \n    // Set batch mode if multiple files\n    const batchMode = nonDuplicateFiles.length > 1;\n    setIsBatchMode(batchMode);\n    \n    // Create preview for first file\n    if (nonDuplicateFiles[0]) {\n      const url = URL.createObjectURL(nonDuplicateFiles[0]);\n      setPreviewUrl(url);\n    }\n    \n    try {\n      if (batchMode) {\n        // Batch processing\n        const results = await openaiVisionService.analyzeBatchDocuments(\n          nonDuplicateFiles,\n          (completed, total, currentFile) => {\n            setBatchProgress({ completed, total, currentFile });\n          }\n        );\n        \n        setBatchResults(results);\n        \n        // Combine all successful extractions\n        const allExtractedData: ExtractedData[] = [];\n        results.results.forEach((result, resultIndex) => {\n          if (result.success) {\n            result.data.forEach(async (item, itemIndex) => {\n              const validation = openaiVisionService.validateExtraction(item);\n              const file = nonDuplicateFiles.find(f => f.name === result.file);\n              \n              // Register document to prevent future duplicates\n              if (file) {\n                await duplicateDetectionService.registerDocument(file, item);\n              }\n              \n              allExtractedData.push({\n                id: `${Date.now()}-${resultIndex}-${itemIndex}`,\n                ...item,\n                needsReview: !validation.isValid || item.confidence < getConfidenceThreshold(item.amount),\n                sourceFile: result.file\n              });\n            });\n          }\n        });\n        \n        setExtractedData(allExtractedData);\n      } else {\n        // Single file processing - use multi-modal AI if image\n        if (nonDuplicateFiles[0].type.startsWith('image/')) {\n          try {\n            const result = await multiModalAPI.processReceiptImage(nonDuplicateFiles[0]);\n            if (result.success) {\n              const extractedItems: ExtractedData[] = [{\n                id: `${Date.now()}-0`,\n                date: result.data.extracted_data.date,\n                description: result.data.extracted_data.vendor || 'Receipt',\n                amount: result.data.extracted_data.amount,\n                category: result.data.extracted_data.category,\n                confidence: result.data.confidence === 'high' ? 0.9 : 0.7,\n                vendor: result.data.extracted_data.vendor,\n                gst_number: result.data.extracted_data.gst_number,\n                needsReview: result.data.confidence !== 'high',\n                sourceFile: nonDuplicateFiles[0].name\n              }];\n              \n              setExtractedData(extractedItems);\n            }\n          } catch (error) {\n            console.error('Multi-modal processing failed, falling back to traditional:', error);\n            // Fallback to traditional processing\n            await processWithTraditionalMethod(nonDuplicateFiles[0]);\n          }\n        } else {\n          // Use traditional processing for PDFs\n          await processWithTraditionalMethod(nonDuplicateFiles[0]);\n        }\n      }\n    } catch (error) {\n      console.error('Document processing failed:', error);\n      setProcessingError('Failed to process documents. Please try again.');\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const processWithTraditionalMethod = async (file: File) => {\n    const processedData = await openaiVisionService.analyzeDocument(file);\n    \n    const extractedItems: ExtractedData[] = [];\n    for (let index = 0; index < processedData.length; index++) {\n      const item = processedData[index];\n      const validation = openaiVisionService.validateExtraction(item);\n      \n      // Register document to prevent future duplicates\n      await duplicateDetectionService.registerDocument(file, item);\n      \n      extractedItems.push({\n        id: `${Date.now()}-${index}`,\n        ...item,\n        needsReview: !validation.isValid || item.confidence < 0.7,\n        sourceFile: file.name\n      });\n    }\n    \n    setExtractedData(extractedItems);\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    const files = e.dataTransfer.files;\n    if (files.length > 0) {\n      handleFileUpload(files);\n    }\n  };\n  \n  const removeFile = (index: number) => {\n    const newFiles = uploadedFiles.filter((_, i) => i !== index);\n    setUploadedFiles(newFiles);\n    \n    if (newFiles.length === 0) {\n      setExtractedData([]);\n      setPreviewUrl('');\n      setBatchResults(null);\n    }\n  };\n  \n  const clearAllFiles = () => {\n    setUploadedFiles([]);\n    setExtractedData([]);\n    setPreviewUrl('');\n    setBatchResults(null);\n    setBatchProgress({ completed: 0, total: 0, currentFile: '' });\n    setDuplicateChecks(new Map());\n    setDuplicatesBlocked(0);\n  };\n\n  const saveExtractedData = async () => {\n    if (extractedData.length === 0) {\n      alert(\"No data to save!\");\n      return;\n    }\n\n    setIsSaving(true);\n    setSaveSuccess(false);\n    \n    try {\n      // Process and save data to earnings table\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user) {\n        throw new Error('User not authenticated');\n      }\n\n      let successCount = 0;\n      let totalRevenue = 0;\n      let totalExpenses = 0;\n      \n      for (const item of extractedData) {\n        const isRevenue = item.amount > 0;\n        const earningsData = {\n          user_id: user.id,\n          earning_date: item.date,\n          amount: isRevenue ? Math.abs(item.amount) : 0,\n          inventory_cost: !isRevenue ? Math.abs(item.amount) : 0,\n          processed_text: JSON.stringify(item),\n          doc_type: 'multimodal_ai'\n        };\n        \n        const { error } = await supabase\n          .from('earnings')\n          .insert(earningsData);\n          \n        if (!error) {\n          successCount++;\n          if (isRevenue) {\n            totalRevenue += Math.abs(item.amount);\n          } else {\n            totalExpenses += Math.abs(item.amount);\n          }\n        }\n      }\n      \n      if (successCount > 0) {\n        setSaveSuccess(true);\n        const netProfit = totalRevenue - totalExpenses;\n        alert(`‚úÖ Successfully saved ${successCount} entries!\\n\\nüìä Summary:\\nüí∞ Revenue: ‚Çπ${totalRevenue.toLocaleString()}\\nüí∏ Expenses: ‚Çπ${totalExpenses.toLocaleString()}\\nüìà Net: ‚Çπ${netProfit.toLocaleString()}`);\n        \n        // Clear data after success\n        setExtractedData([]);\n        setUploadedFiles([]);\n        setPreviewUrl('');\n        setBatchResults(null);\n      }\n      \n    } catch (error) {\n      console.error('Save error:', error);\n      alert(`‚ùå Failed to save data: ${error.message}`);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"text-center mb-8\">\n        <h2 className=\"text-2xl font-bold mb-2 flex items-center justify-center gap-2\">\n          <Zap className=\"h-6 w-6 text-blue-600\" />\n          AI-Powered Document Processing\n        </h2>\n        <p className=\"text-gray-600\">\n          Revolutionary multi-modal AI: Camera, Voice, and Traditional Upload\n        </p>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"multimodal\" className=\"flex items-center gap-2\">\n            <Camera className=\"h-4 w-4\" />\n            Multi-Modal AI\n          </TabsTrigger>\n          <TabsTrigger value=\"traditional\" className=\"flex items-center gap-2\">\n            <Upload className=\"h-4 w-4\" />\n            Traditional Upload\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"multimodal\">\n          <MultiModalUploader />\n        </TabsContent>\n\n        <TabsContent value=\"traditional\" className=\"space-y-6\">\n          {/* Traditional Upload Section */}\n          <Card className=\"modern-card\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Upload className=\"h-5 w-5\" />\n                Traditional Document Upload\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {!uploadedFiles.length ? (\n                <div\n                  className=\"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center space-y-4 cursor-pointer hover:border-primary/50 transition-colors\"\n                  onDragOver={handleDragOver}\n                  onDrop={handleDrop}\n                  onClick={() => fileInputRef.current?.click()}\n                >\n                  <div className=\"w-16 h-16 mx-auto bg-primary/10 rounded-full flex items-center justify-center\">\n                    <FileText className=\"h-8 w-8 text-primary\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-lg font-semibold\">Upload your documents</h3>\n                    <p className=\"text-muted-foreground\">\n                      Drag and drop files here, or click to browse\n                    </p>\n                    <p className=\"text-sm text-muted-foreground mt-2\">\n                      Supports: PDF, JPG, PNG (Max 10MB each) ‚Ä¢ Multiple files supported\n                    </p>\n                  </div>\n                  \n                  <Button size=\"lg\" className=\"btn-primary\">\n                    <Upload className=\"h-4 w-4 mr-2\" />\n                    Choose Files\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {/* File List */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <h4 className=\"text-sm font-medium\">\n                        {uploadedFiles.length} file{uploadedFiles.length !== 1 ? 's' : ''} selected\n                      </h4>\n                      <Button variant=\"ghost\" size=\"sm\" onClick={clearAllFiles}>\n                        <Trash2 className=\"h-4 w-4 mr-1\" />\n                        Clear All\n                      </Button>\n                    </div>\n                    \n                    <div className=\"max-h-32 overflow-y-auto space-y-1\">\n                      {uploadedFiles.map((file, index) => (\n                        <div key={index} className=\"flex items-center justify-between p-2 bg-muted/30 rounded\">\n                          <div className=\"flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                            <div>\n                              <p className=\"text-sm font-medium truncate max-w-48\">{file.name}</p>\n                              <p className=\"text-xs text-muted-foreground\">\n                                {(file.size / 1024 / 1024).toFixed(2)} MB\n                              </p>\n                            </div>\n                          </div>\n                          <Button variant=\"ghost\" size=\"sm\" onClick={() => removeFile(index)}>\n                            <X className=\"h-3 w-3\" />\n                          </Button>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                  \n                  {/* Processing Progress */}\n                  {isProcessing && (\n                    <div className=\"space-y-3\">\n                      {isBatchMode ? (\n                        <div className=\"space-y-2\">\n                          <div className=\"flex items-center justify-between text-sm\">\n                            <span>Processing documents...</span>\n                            <span>{batchProgress.completed}/{batchProgress.total}</span>\n                          </div>\n                          <Progress \n                            value={(batchProgress.completed / batchProgress.total) * 100} \n                            className=\"h-2\"\n                          />\n                          {batchProgress.currentFile && (\n                            <p className=\"text-xs text-muted-foreground truncate\">\n                              Current: {batchProgress.currentFile}\n                            </p>\n                          )}\n                        </div>\n                      ) : (\n                        <div className=\"text-center py-4\">\n                          <div className=\"w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2\"></div>\n                          <p className=\"text-sm text-muted-foreground\">Analyzing with AI...</p>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                  \n                  {processingError && (\n                    <div className=\"border rounded-lg p-4 bg-destructive/10 border-destructive/20 flex items-center gap-2\">\n                      <AlertTriangle className=\"h-4 w-4 text-destructive\" />\n                      <p className=\"text-sm text-destructive\">{processingError}</p>\n                    </div>\n                  )}\n                </div>\n              )}\n              \n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                className=\"hidden\"\n                accept=\".pdf,.jpg,.jpeg,.png\"\n                multiple\n                onChange={(e) => {\n                  if (e.target.files && e.target.files.length > 0) {\n                    handleFileUpload(e.target.files);\n                  }\n                }}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Extracted Data Display */}\n          {extractedData.length > 0 && (\n            <Card className=\"modern-card\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle className=\"text-base\">Extracted Data</CardTitle>\n                  <Badge variant=\"outline\" className=\"bg-success/10 text-success border-success/20\">\n                    ‚úì {extractedData.length} entries found\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3 max-h-64 overflow-y-auto\">\n                  {extractedData.map((item) => (\n                    <div key={item.id} className={cn(\n                      \"p-3 rounded-lg border\",\n                      item.needsReview ? \"bg-yellow-50 border-yellow-200\" : \"bg-muted/30 border-transparent\"\n                    )}>\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            <span className=\"text-sm font-medium\">{item.description}</span>\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {item.category}\n                            </Badge>\n                            {item.confidence && (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {Math.round(item.confidence * 100)}%\n                              </Badge>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-4 mt-1\">\n                            <p className=\"text-xs text-muted-foreground\">{item.date}</p>\n                            {item.vendor && (\n                              <p className=\"text-xs text-muted-foreground\">‚Ä¢ {item.vendor}</p>\n                            )}\n                          </div>\n                        </div>\n                        <div className={cn(\n                          \"text-sm font-medium\",\n                          item.amount > 0 ? \"text-success\" : \"text-destructive\"\n                        )}>\n                          {item.amount > 0 ? \"+\" : \"\"}‚Çπ{Math.abs(item.amount).toLocaleString()}\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n                \n                <div className=\"mt-4 pt-4 border-t\">\n                  <Button \n                    onClick={saveExtractedData} \n                    className=\"w-full btn-primary\"\n                    disabled={isSaving || extractedData.length === 0}\n                  >\n                    {isSaving ? (\n                      <>\n                        <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2\"></div>\n                        Saving...\n                      </>\n                    ) : (\n                      <>\n                        <Save className=\"h-4 w-4 mr-2\" />\n                        Save {extractedData.length} Entries\n                      </>\n                    )}\n                  </Button>\n                  \n                  {saveSuccess && (\n                    <div className=\"mt-2 p-2 bg-green-50 border border-green-200 rounded text-center\">\n                      <div className=\"flex items-center justify-center gap-1 text-green-800 text-sm\">\n                        <Check className=\"h-4 w-4\" />\n                        <span>Data saved successfully!</span>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      <div className=\"bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4\">\n        <div className=\"flex items-center gap-2 mb-2\">\n          <Zap className=\"h-5 w-5 text-blue-600\" />\n          <h3 className=\"font-semibold text-blue-900\">Multi-Modal AI Features</h3>\n        </div>\n        <div className=\"grid md:grid-cols-3 gap-4 text-sm\">\n          <div className=\"flex items-center gap-2\">\n            <Camera className=\"h-4 w-4 text-blue-600\" />\n            <span>GPT-4 Vision for instant receipt analysis</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Mic className=\"h-4 w-4 text-blue-600\" />\n            <span>Voice commands in Hindi & English</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Eye className=\"h-4 w-4 text-blue-600\" />\n            <span>Business photo intelligence</span>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}